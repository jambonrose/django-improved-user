name: Publish package to PyPI

on:
    push:
        tags:
            - "v*"

jobs:
    build:
        name: Build package
        runs-on: ubuntu-22.04
        environment: publish
        steps:
            - uses: actions/checkout@v4

            - name: Build sdist
              run: pipx run build --sdist --wheel

            - uses: actions/upload-artifact@v4
              with:
                  path: dist/*

    publish:
        name: Upload release to PyPI
        needs: [build]
        runs-on: ubuntu-22.04
        environment:
            name: publish
            url: https://pypi.org/p/django-improved-user/
        permissions:
            id-token: write
        steps:
            - name: Download artifact from build step
              uses: actions/download-artifact@v4
              with:
                  name: artifact
                  path: dist

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
